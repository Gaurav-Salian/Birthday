<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Controlled Endless Platformer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
</head>
<body>
    <script>
        let player;
        let platforms = [];
        let mic;
        let baseScrollSpeed = 2;
        let scrollSpeed = 0; // No movement without sound
        let gameOver = false;
        let lastSoundTime = 0;
        let soundDuration = 0;

        function setup() {
            createCanvas(800, 600);
            // Initialize microphone
            mic = new p5.AudioIn();
            mic.start();
            // Initialize player on first platform
            platforms.push(createPlatform(100));
            player = {
                x: 100,
                y: platforms[0].y - 15,
                vy: 0,
                size: 30,
                onPlatform: true
            };
            // Create initial platforms
            for (let i = 1; i < 5; i++) {
                platforms.push(createPlatform(100 + i * 200));
            }
        }

        function draw() {
            background(220);
            
            if (!gameOver) {
                // Get microphone volume (0 to 1)
                let vol = mic.getLevel();
                
                // Track sound duration for longer screams
                if (vol > 0.05) { // Increased threshold for less sensitivity
                    if (lastSoundTime === 0) {
                        lastSoundTime = millis();
                    }
                    soundDuration = (millis() - lastSoundTime) / 1000; // Duration in seconds
                    // Set scroll speed based on sound
                    scrollSpeed = map(vol * soundDuration, 0, 0.5, baseScrollSpeed, 5, true); // Reduced sensitivity
                } else {
                    lastSoundTime = 0;
                    soundDuration = 0;
                    scrollSpeed = 0; // No movement without sound
                }

                // Map volume and duration to jump strength
                let jumpStrength = map(vol * soundDuration, 0, 0.5, 0, -15, true); // Reduced sensitivity

                // Player jump logic (only jump when on platform)
                if (jumpStrength < -2 && player.onPlatform) {
                    player.vy = jumpStrength;
                    player.onPlatform = false;
                }

                // Update player
                player.vy += 0.5; // Gravity
                player.y += player.vy;
                player.x += scrollSpeed; // Move player with screen scroll

                // Check if player is on a platform
                player.onPlatform = false;
                for (let platform of platforms) {
                    if (player.x + player.size / 2 > platform.x &&
                        player.x - player.size / 2 < platform.x + platform.width &&
                        player.y + player.size / 2 > platform.y &&
                        player.y + player.size / 2 < platform.y + 20 &&
                        player.vy > 0) {
                        player.y = platform.y - player.size / 2;
                        player.vy = 0;
                        player.onPlatform = true;
                    }
                }

                // If player falls off screen, game over
                if (player.y - player.size / 2 > height) {
                    gameOver = true;
                }

                // Scroll platforms
                for (let platform of platforms) {
                    platform.x -= scrollSpeed;
                }

                // Remove off-screen platforms and add new ones
                if (platforms[0].x + platforms[0].width < 0) {
                    platforms.shift();
                    let lastPlatform = platforms[platforms.length - 1];
                    platforms.push(createPlatform(lastPlatform.x + 200));
                }

                // Draw platforms (tall pillars to bottom)
                fill(100);
                for (let platform of platforms) {
                    rect(platform.x, platform.y, platform.width, height - platform.y);
                }

                // Draw player
                fill(255, 0, 0);
                ellipse(player.x, player.y, player.size);

                // Display volume and duration meter
                let volHeight = map(vol * soundDuration, 0, 0.5, 0, 100, true);
                fill(0, 255, 0);
                rect(10, height - 110, 20, volHeight);
            } else {
                // Game over screen
                fill(0);
                textSize(32);
                textAlign(CENTER);
                text("Game Over! Refresh to restart.", width / 2, height / 2);
            }
        }

        function createPlatform(x) {
            return {
                x: x,
                y: random(height * 0.3, height * 0.7),
                width: random(40, 150), // Random width, min 40px for character to stand
                height: height // Extends to bottom
            };
        }
    </script>
</body>
</html>
